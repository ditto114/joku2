<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ì¡°ì¿ ê³µëŒ€ ê´€ë¦¬í˜ì´ì§€</title>
    <link rel="stylesheet" href="./admin.css" />
    
</head>

<body class="body-layout">
    <header class="admin-header">
        <div class="header-row">
            <h1 class="page-title">ğŸ® ì¡°ì¿ ê³µëŒ€ ê´€ë¦¬í˜ì´ì§€</h1>
            <div class="header-actions">
                <button class="btn-secondary" data-open-modal="pricesDialog">ğŸ’° ì‹œì„¸ ë³€ê²½</button>
                <button class="btn-secondary" data-open-modal="resetDialog">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
                <button class="btn-secondary" data-open-modal="membersDialog">ğŸ›¡ï¸ ê³µëŒ€ì› ê´€ë¦¬</button>
                <button id="sendScreenshot" class="btn-ghost">ğŸ–¼ï¸ í™”ë©´ ì „ì†¡</button>
            </div>
        </div>
    </header>

    <!-- ë¡œê·¸ì¸ ê²Œì´íŠ¸ -->
    <section id="gate" class="hidden">
        <h2 class="gate-title">ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
        <div class="gate-row">
            <input id="pwd" type="password" class="gate-input" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
            <button id="loginBtn" class="btn-primary">ì ‘ì†</button>
        </div>
        <div id="gateMsg" class="gate-message"></div>
    </section>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main id="app" class="hidden main-grid">
        <section class="card home-card view-card" id="homeCard">
            <h2 class="card-title">ğŸ“‹ ì‚¬ìš©í•  ë„êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
            <p class="card-subtitle">ê´€ë¦¬ í˜ì´ì§€ì—ì„œ ìì¿° ì˜ˆì•½ í˜„í™©ê³¼ í˜¼í…Œì¼ íƒ€ì´ë¨¸ë¥¼ ë¹ ë¥´ê²Œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <div class="home-actions">
                <button class="btn-primary btn-prominent" data-nav-target="reservation">ìì¿° ì˜ˆì•½ í˜„í™© ë°”ë¡œê°€ê¸°</button>
                <button class="btn-secondary btn-prominent" data-nav-target="timer">í˜¼í…Œì¼ íƒ€ì´ë¨¸ ë°”ë¡œê°€ê¸°</button>
            </div>
        </section>

        <section class="card reservation-card view-card hidden" id="reservationStatusCard">
            <div class="card-header">
                <h2 class="card-title">ğŸ§‘â€ğŸ¤â€ğŸ§‘ í˜„ì¬ ì˜ˆì•½ í˜„í™©</h2>
                <div class="card-header-actions view-nav">
                    <button class="btn-ghost" data-nav-target="home">â† ë„êµ¬ ì„ íƒ</button>
                    <button class="btn-secondary" data-nav-target="timer">í˜¼í…Œì¼ íƒ€ì´ë¨¸</button>
                </div>
            </div>
            <div id="statusBox" class="reservation-grid">
                <div class="status-msg">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </section>

        <section class="card timer-card view-card hidden" id="timerView">
            <div class="card-header">
                <h2 class="card-title">ğŸ‰ í˜¼í…Œì¼ íƒ€ì´ë¨¸</h2>
                <div class="card-header-actions view-nav">
                    <button class="btn-ghost" data-nav-target="home">â† ë„êµ¬ ì„ íƒ</button>
                    <button class="btn-secondary" data-nav-target="reservation">ìì¿° ì˜ˆì•½ í˜„í™©</button>
                </div>
            </div>
            <div class="timer-actions">
                <button id="addTimer" class="btn-primary">â• íƒ€ì´ë¨¸ ì¶”ê°€</button>
            </div>
            <div id="timerList" class="timer-list">
                <div class="timer-empty">íƒ€ì´ë¨¸ë¥¼ ì¶”ê°€í•˜ë©´ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
            </div>
        </section>
    </main>

    <!-- ì‹œì„¸ ë³€ê²½ ëª¨ë‹¬ -->
    <dialog id="pricesDialog">
        <div class="modal">
            <h3>ğŸ’° ì‹œì„¸ ë³€ê²½</h3>
            <div class="modal-body">
                <div class="form-group">
                    <label>í™•íˆ¬ (1ìˆœ, 2ìˆœ)</label>
                    <div class="input-wrapper">
                        <input id="p1" type="number" placeholder="1000" />
                        <span class="input-suffix">ê³¨ë“œ</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>3ìˆœ</label>
                    <div class="input-wrapper">
                        <input id="p2" type="number" placeholder="800" />
                        <span class="input-suffix">ê³¨ë“œ</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>ìŠ¤í‚¬ë¶1</label>
                    <div class="input-wrapper">
                        <input id="p3" type="number" placeholder="1000" />
                        <span class="input-suffix">ê³¨ë“œ</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>ìŠ¤í‚¬ë¶2</label>
                    <div class="input-wrapper">
                        <input id="p4" type="number" placeholder="300" />
                        <span class="input-suffix">ê³¨ë“œ</span>
                    </div>
                </div>
            </div>
            <div id="priceMsg" class="status-msg hidden"></div>
            <div class="modal-actions">
                <button class="btn-secondary" data-close-modal>ë‹«ê¸°</button>
                <button id="savePrices" class="btn-primary">ğŸ’¾ ì‹œì„¸ ì €ì¥</button>
            </div>
        </div>
    </dialog>

    <!-- ì´ˆê¸°í™” ëª¨ë‹¬ -->
    <dialog id="resetDialog" class="modal-wide">
        <div class="modal">
            <h3>ğŸ—‘ï¸ ì˜ˆì•½ ì´ˆê¸°í™”</h3>
            <div class="modal-body">
                <select id="resetSel" class="reset-select" multiple>
                    <option value="turn1_first">1íŠ¸ 1ìˆœ</option>
                    <option value="turn1_second">1íŠ¸ 2ìˆœ</option>
                    <option value="turn1_third">1íŠ¸ 3ìˆœ</option>
                    <option value="turn2_first">2íŠ¸ 1ìˆœ</option>
                    <option value="turn2_second">2íŠ¸ 2ìˆœ</option>
                    <option value="turn2_third">2íŠ¸ 3ìˆœ</option>
                    <option value="skillbook1">ìŠ¤í‚¬ë¶1</option>
                    <option value="skillbook2">ìŠ¤í‚¬ë¶2</option>
                    <option value="enre_eat">ì—”ë ˆë¨¹ì</option>
                </select>
                <div class="btn-group">
                    <button id="resetSome" class="btn-primary flex-1">ì„ íƒ ì´ˆê¸°í™”</button>
                    <button id="resetAll" class="btn-danger flex-1">ëª¨ë‘ ì´ˆê¸°í™”</button>
                </div>
            </div>
            <div id="resetMsg" class="status-msg hidden"></div>
            <div class="modal-actions">
                <button class="btn-secondary" data-close-modal>ë‹«ê¸°</button>
            </div>
        </div>
    </dialog>

    <!-- ê³µëŒ€ì› ê´€ë¦¬ ëª¨ë‹¬ -->
    <dialog id="membersDialog" class="modal-large">
        <div class="modal">
            <h3>ğŸ›¡ï¸ ê³µëŒ€ì› ëª…ë‹¨ ê´€ë¦¬</h3>
            <div class="modal-subactions btn-group">
                <button id="mAdd" class="btn-primary">â• ê³µëŒ€ì› ì¶”ê°€</button>
                <button id="mDel" class="btn-danger">â– ê³µëŒ€ì› ì œê±°</button>
                <button id="mReload" class="btn-secondary">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div id="mBox" class="member-list">
                <div class="status-msg">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            <div id="mMsg" class="status-msg hidden"></div>
            <div class="modal-actions">
                <button class="btn-secondary" data-close-modal>ë‹«ê¸°</button>
            </div>
        </div>
    </dialog>

    <!-- ì¶œë°œì‹œê°„ ë³€ê²½ ëª¨ë‹¬ -->
    <dialog id="timeDialog">
        <div class="modal">
            <h3 id="timeTitle">â° ì¶œë°œì‹œê°„ ë³€ê²½</h3>
            <div class="modal-grid">
                <div class="form-group">
                    <label>ì‹œ (0-23)</label>
                    <input id="th" type="number" min="0" max="23" />
                </div>
                <div class="form-group">
                    <label>ë¶„ (0-59)</label>
                    <input id="tm" type="number" min="0" max="59" />
                </div>
            </div>
            <div class="modal-actions">
                <button id="timeCancel" class="btn-secondary">ì·¨ì†Œ</button>
                <button id="timeSave" class="btn-primary">ì €ì¥</button>
            </div>
        </div>
    </dialog>

    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const $ = (id) => document.getElementById(id);
        const app = $('app'), gate = $('gate'), gateMsg = $('gateMsg');
        const headerActions = document.querySelector('.header-actions');
        const viewSections = {
            home: $('homeCard'),
            reservation: $('reservationStatusCard'),
            timer: $('timerView')
        };
        const timerList = $('timerList');
        const addTimerBtn = $('addTimer');
        const PWD_KEY = 'admin_password';
        const getPwd = () => sessionStorage.getItem(PWD_KEY) || '';
        const setPwd = v => sessionStorage.setItem(PWD_KEY, v || '');
        const clearPwd = () => sessionStorage.removeItem(PWD_KEY);
        const authHeaders = () => ({ 'x-admin-password': getPwd() });

        const LOOT_STORAGE_KEY = 'joku_admin_loot_state_v1';

        let activeView = 'home';
        let statusViewInitialized = false;
        let timerData = [];
        let timerIndex = new Map();
        let timerTickHandle = null;
        let timersLoadedOnce = false;
        const editingTimers = new Set();
        let pendingFocusTimerId = null;

        function withStorage(fn, fallback) {
            try { return fn(); }
            catch { return fallback; }
        }

        let lootState = withStorage(() => JSON.parse(localStorage.getItem(LOOT_STORAGE_KEY) || '{}'), {});

        function saveLootState() {
            withStorage(() => localStorage.setItem(LOOT_STORAGE_KEY, JSON.stringify(lootState)), null);
        }

        const escapeHtml = (str = '') => String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');

        const escapeAttr = (str = '') => escapeHtml(str).replace(/`/g, '&#96;');

        const clampTimerValue = (ms) => {
            if (!Number.isFinite(ms)) return 0;
            return Math.max(0, Math.round(ms));
        };

        const clampTimerInput = (value, max) => {
            const num = Number(value);
            if (!Number.isFinite(num)) return 0;
            return Math.max(0, Math.min(max, Math.floor(num)));
        };

        const formatTimerDuration = (ms) => {
            const totalSeconds = Math.max(0, Math.floor(clampTimerValue(ms) / 1000));
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        };

        function ensureTimerTicker() {
            if (timerTickHandle) return;
            timerTickHandle = setInterval(() => updateTimerCountdowns(), 1000);
        }

        function stopTimerTicker() {
            if (timerTickHandle) {
                clearInterval(timerTickHandle);
                timerTickHandle = null;
            }
        }

        function activateView(view = 'home') {
            const target = viewSections[view] ? view : 'home';
            activeView = target;
            Object.entries(viewSections).forEach(([key, el]) => {
                if (!el) return;
                if (key === target) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });

            if (headerActions) {
                if (target === 'reservation') {
                    headerActions.classList.remove('hidden');
                } else {
                    headerActions.classList.add('hidden');
                }
            }

            if (target !== 'timer') {
                stopTimerTicker();
            }

            if (target === 'reservation' && !statusViewInitialized) {
                statusViewInitialized = true;
                loadStatus();
            }

            if (target === 'timer') {
                if (!timersLoadedOnce) {
                    loadTimers(true);
                } else {
                    loadTimers();
                }
                ensureTimerTicker();
            }
        }

        function setTimerSnapshot(snapshot) {
            if (!snapshot || typeof snapshot !== 'object') return;
            const timers = Array.isArray(snapshot.timers) ? snapshot.timers : [];

            const serverNow = Number(snapshot.serverTime);
            const clientNow = Date.now();
            const offset = Number.isFinite(serverNow) ? clientNow - serverNow : 0;

            const sanitizedTimers = timers
                .filter(item => item && typeof item === 'object')
                .map(item => {
                    const id = String(item.id ?? '').trim();
                    if (!id) return null;
                    const durationMs = clampTimerValue(item.durationMs);
                    const remainingMs = clampTimerValue(item.remainingMs);
                    const startedAt = Number.isFinite(item.startedAt) ? Number(item.startedAt) : null;
                    const isRunning = Boolean(item.isRunning) && remainingMs > 0;
                    const clientStart = isRunning
                        ? (startedAt != null ? startedAt + offset : clientNow - Math.max(0, durationMs - remainingMs))
                        : null;
                    return {
                        id,
                        name: String(item.name ?? ''),
                        durationMs,
                        remainingMs,
                        isRunning,
                        repeat: Boolean(item.repeat),
                        startedAt: isRunning && startedAt != null ? startedAt : null,
                        _clientStartedAt: isRunning ? clientStart : null,
                        _lastSyncedAt: clientNow
                    };
                })
                .filter(Boolean);

            timerData = sanitizedTimers.map(timer => ({ ...timer }));
            timerIndex = new Map(timerData.map(timer => [timer.id, timer]));
            Array.from(editingTimers).forEach(id => {
                if (!timerIndex.has(id)) {
                    editingTimers.delete(id);
                }
            });
            renderTimerList();
            updateTimerCountdowns(true);
            timersLoadedOnce = true;

            if (activeView === 'timer') {
                ensureTimerTicker();
            } else {
                stopTimerTicker();
            }
        }

        function renderTimerList() {
            if (!timerList) return;
            if (!timerData || timerData.length === 0) {
                timerList.innerHTML = '<div class="timer-empty">íƒ€ì´ë¨¸ë¥¼ ì¶”ê°€í•˜ë©´ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.</div>';
                return;
            }

            timerList.innerHTML = timerData.map(renderTimerItem).join('');

            if (pendingFocusTimerId) {
                requestAnimationFrame(() => {
                    const target = timerList.querySelector(`[data-timer-id="${pendingFocusTimerId}"] .timer-name`);
                    if (target) {
                        target.focus();
                        if (typeof target.select === 'function') {
                            target.select();
                        }
                    }
                    pendingFocusTimerId = null;
                });
            }
        }

        function renderTimerItem(timer) {
            const minutes = Math.floor(timer.durationMs / 60000);
            const seconds = Math.floor((timer.durationMs / 1000) % 60);
            const remainingDisplay = formatTimerDuration(timer.remainingMs);
            const toggleLabel = timer.isRunning ? 'ë¦¬ì…‹' : 'ì‹œì‘';
            const repeatActive = Boolean(timer.repeat);
            const isEditing = editingTimers.has(timer.id);
            const durationDisplay = `${String(minutes).padStart(2, '0')}ë¶„ ${String(seconds).padStart(2, '0')}ì´ˆ`;
            const progressPercent = timer.durationMs > 0
                ? Math.max(0, Math.min(100, (timer.remainingMs / timer.durationMs) * 100))
                : 0;

            return `
                <div class="timer-item${timer.isRunning ? ' is-running' : ''}" data-timer-id="${escapeAttr(timer.id)}" data-running="${timer.isRunning ? 'true' : 'false'}" data-editing="${isEditing ? 'true' : 'false'}">
                    <div class="timer-shell">
                        <div class="timer-main">
                            <div class="timer-header">
                                <div class="timer-title-group">
                                    <span class="timer-repeat-badge${repeatActive ? ' is-active' : ''}" data-role="repeatBadge">ë°˜ë³µì¤‘</span>
                                    ${isEditing
                                        ? `<input type="text" class="timer-name" value="${escapeHtml(timer.name || '')}" placeholder="íƒ€ì´ë¨¸ ì´ë¦„" />`
                                        : `<div class="timer-title-text">${escapeHtml(timer.name || 'ìƒˆ íƒ€ì´ë¨¸')}</div>`}
                                </div>
                                <button type="button" class="btn-outline timer-edit-button" data-timer-action="edit">${isEditing ? 'ì™„ë£Œ' : 'ìˆ˜ì •'}</button>
                            </div>
                            <div class="timer-display">
                                <div class="timer-digits" data-role="remaining">${remainingDisplay}</div>
                            </div>
                            ${isEditing
                                ? `<div class="timer-edit-fields">
                                        <label class="timer-input">
                                            <span class="timer-input-label">ë¶„</span>
                                            <input type="number" inputmode="numeric" class="timer-minute" min="0" max="720" value="${minutes}" />
                                        </label>
                                        <label class="timer-input">
                                            <span class="timer-input-label">ì´ˆ</span>
                                            <input type="number" inputmode="numeric" class="timer-second" min="0" max="59" value="${seconds}" />
                                        </label>
                                    </div>`
                                : `<div class="timer-duration-display">
                                        <span class="timer-duration-label">ì„¤ì • ì‹œê°„</span>
                                        <span class="timer-duration-value">${durationDisplay}</span>
                                    </div>`}
                            <div class="timer-footer">
                                <button type="button" class="timer-repeat-button${repeatActive ? ' is-active' : ''}" data-timer-action="repeat">ë°˜ë³µ</button>
                                ${isEditing ? `<button type="button" class="btn-danger timer-delete" data-timer-action="delete">ì‚­ì œ</button>` : ''}
                            </div>
                        </div>
                        <button type="button" class="timer-cta-panel${timer.isRunning ? ' is-running' : ''}" data-timer-action="toggle">${toggleLabel}</button>
                    </div>
                    <div class="timer-progress">
                        <div class="timer-progress-bar" data-role="progressBar" style="width: ${progressPercent}%;"></div>
                    </div>
                </div>`;
        }

        function updateTimerCountdowns(force = false) {
            if (!timerList || timerIndex.size === 0) return;
            const now = Date.now();

            timerIndex.forEach(timer => {
                if (!timer) return;

                const duration = clampTimerValue(timer.durationMs);
                const baseRemaining = clampTimerValue(timer.remainingMs);

                if (timer.isRunning && duration > 0) {
                    if (timer._clientStartedAt == null) {
                        const elapsedSoFar = Math.max(0, duration - baseRemaining);
                        timer._clientStartedAt = now - elapsedSoFar;
                    }

                    const elapsed = Math.max(0, now - timer._clientStartedAt);

                    if (timer.repeat) {
                        if (duration <= 0) {
                            timer.remainingMs = 0;
                            timer.isRunning = false;
                            timer._clientStartedAt = null;
                        } else {
                            const remainder = elapsed % duration;
                            let nextRemaining = duration - remainder;
                            if (nextRemaining <= 0) {
                                nextRemaining = duration;
                            }
                            timer.remainingMs = nextRemaining;
                            timer._clientStartedAt = now - remainder;
                            timer.isRunning = true;
                        }
                    } else {
                        const nextRemaining = Math.max(0, duration - elapsed);
                        if (nextRemaining <= 0) {
                            timer.remainingMs = 0;
                            timer.isRunning = false;
                            timer._clientStartedAt = null;
                        } else {
                            timer.remainingMs = nextRemaining;
                        }
                    }
                } else {
                    timer.remainingMs = baseRemaining;
                    timer._clientStartedAt = null;
                }

                if (!timer.isRunning && timer.remainingMs < 0) {
                    timer.remainingMs = 0;
                }
            });

            timerList.querySelectorAll('.timer-item').forEach(item => {
                const id = item.getAttribute('data-timer-id');
                if (!id) return;
                const timer = timerIndex.get(id);
                if (!timer) return;

                const remaining = clampTimerValue(timer.remainingMs);

                const remainingEl = item.querySelector('[data-role="remaining"]');
                if (remainingEl) {
                    remainingEl.textContent = formatTimerDuration(remaining);
                }

                const toggleBtn = item.querySelector('button[data-timer-action="toggle"]');
                if (toggleBtn) {
                    toggleBtn.textContent = timer.isRunning ? 'ë¦¬ì…‹' : 'ì‹œì‘';
                    toggleBtn.classList.toggle('is-running', timer.isRunning);
                }

                const repeatBtn = item.querySelector('button[data-timer-action="repeat"]');
                if (repeatBtn) {
                    repeatBtn.classList.toggle('is-active', Boolean(timer.repeat));
                }

                const repeatBadge = item.querySelector('[data-role="repeatBadge"]');
                if (repeatBadge) {
                    repeatBadge.classList.toggle('is-active', Boolean(timer.repeat));
                }

                const progressBar = item.querySelector('[data-role="progressBar"]');
                if (progressBar) {
                    const duration = clampTimerValue(timer.durationMs);
                    const percent = duration > 0 ? Math.max(0, Math.min(1, remaining / duration)) * 100 : 0;
                    progressBar.style.width = `${percent}%`;
                }

                item.dataset.running = timer.isRunning ? 'true' : 'false';
                item.classList.toggle('is-running', timer.isRunning);
            });
        }

        async function loadTimers(showFeedback = false) {
            if (!getPwd()) return;
            try {
                const r = await fetch('/api/timers', {
                    headers: authHeaders(),
                    credentials: 'same-origin'
                });
                const j = await jsonOrThrow(r);
                if (!j?.ok) {
                    throw new Error(j?.error || 'íƒ€ì´ë¨¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                }
                const snapshot = j.snapshot || { serverTime: j.serverTime, timers: j.timers };
                setTimerSnapshot(snapshot);
            } catch (e) {
                console.error(e);
            }
        }

        async function requestTimer(path, options) {
            try {
                const r = await fetch(path, options);
                const j = await jsonOrThrow(r);
                if (!j?.ok) {
                    throw new Error(j?.error || 'ìš”ì²­ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                await loadTimers();
                return j;
            } catch (e) {
                console.error(e);
                throw e;
            }
        }

        if (addTimerBtn) {
            addTimerBtn.addEventListener('click', async () => {
                if (!getPwd()) {
                    showGate('âŒ ì¸ì¦ í•„ìš”: ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                    return;
                }
                addTimerBtn.disabled = true;
                try {
                    await requestTimer('/api/timers', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        credentials: 'same-origin',
                        body: JSON.stringify({})
                    });
                } catch (e) {
                    // ì—ëŸ¬ëŠ” ì½˜ì†”ì— ê¸°ë¡ë¨
                } finally {
                    addTimerBtn.disabled = false;
                }
            });
        }

        if (timerList) {
            timerList.addEventListener('click', async (event) => {
                const btn = event.target.closest('button[data-timer-action]');
                if (!btn) return;
                if (!getPwd()) {
                    showGate('âŒ ì¸ì¦ í•„ìš”: ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                    return;
                }
                const row = btn.closest('.timer-item');
                if (!row) return;
                const id = row.getAttribute('data-timer-id');
                if (!id) return;
                const action = btn.getAttribute('data-timer-action');
                if (!action) return;

                if (action === 'edit') {
                    const isEditing = editingTimers.has(id);
                    const rowEl = btn.closest('.timer-item');
                    if (isEditing && rowEl) {
                        const minuteInput = rowEl.querySelector('.timer-minute');
                        const secondInput = rowEl.querySelector('.timer-second');
                        const nameInput = rowEl.querySelector('.timer-name');
                        if (minuteInput) {
                            minuteInput.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                        if (secondInput && secondInput !== minuteInput) {
                            secondInput.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                        if (nameInput) {
                            nameInput.dispatchEvent(new Event('focusout', { bubbles: true }));
                        }
                        editingTimers.delete(id);
                        pendingFocusTimerId = null;
                    } else {
                        editingTimers.add(id);
                        pendingFocusTimerId = id;
                    }
                    renderTimerList();
                    updateTimerCountdowns(true);
                    return;
                }

                if (action === 'delete' && !confirm('ì„ íƒí•œ íƒ€ì´ë¨¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }

                btn.disabled = true;
                try {
                    if (action === 'toggle') {
                        const current = timerIndex.get(id);
                        const running = current?.isRunning;
                        const endpoint = running ? 'reset' : 'start';
                        await requestTimer(`/api/timers/${id}/${endpoint}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...authHeaders() },
                            credentials: 'same-origin',
                            body: JSON.stringify({})
                        });
                    } else if (action === 'repeat') {
                        const current = timerIndex.get(id);
                        const nextRepeat = !Boolean(current?.repeat);
                        await requestTimer(`/api/timers/${id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json', ...authHeaders() },
                            credentials: 'same-origin',
                            body: JSON.stringify({ repeat: nextRepeat })
                        });
                    } else if (action === 'delete') {
                        await requestTimer(`/api/timers/${id}`, {
                            method: 'DELETE',
                            headers: { ...authHeaders() },
                            credentials: 'same-origin'
                        });
                    }
                } catch (e) {
                    // ì—ëŸ¬ëŠ” ì½˜ì†”ì— ê¸°ë¡ë¨
                } finally {
                    btn.disabled = false;
                }
            });

            timerList.addEventListener('change', async (event) => {
                const input = event.target;
                if (!input.classList.contains('timer-minute') && !input.classList.contains('timer-second')) return;
                if (!getPwd()) {
                    showGate('âŒ ì¸ì¦ í•„ìš”: ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                    return;
                }
                const row = input.closest('.timer-item');
                if (!row) return;
                const id = row.getAttribute('data-timer-id');
                if (!id) return;
                const minuteInput = row.querySelector('.timer-minute');
                const secondInput = row.querySelector('.timer-second');
                const minutes = clampTimerInput(minuteInput?.value, 720);
                const seconds = clampTimerInput(secondInput?.value, 59);
                const current = timerIndex.get(id);
                if (current) {
                    const currentMinutes = Math.floor(current.durationMs / 60000);
                    const currentSeconds = Math.floor((current.durationMs / 1000) % 60);
                    if (minutes === currentMinutes && seconds === currentSeconds) {
                        if (minuteInput) minuteInput.value = currentMinutes;
                        if (secondInput) secondInput.value = currentSeconds;
                        return;
                    }
                }

                input.disabled = true;
                try {
                    await requestTimer(`/api/timers/${id}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        credentials: 'same-origin',
                        body: JSON.stringify({ minutes, seconds })
                    });
                } catch (e) {
                    const fallback = timerIndex.get(id);
                    if (fallback) {
                        if (minuteInput) minuteInput.value = Math.floor(fallback.durationMs / 60000);
                        if (secondInput) secondInput.value = Math.floor((fallback.durationMs / 1000) % 60);
                    }
                } finally {
                    input.disabled = false;
                }
            });

            timerList.addEventListener('focusout', async (event) => {
                const input = event.target;
                if (!input.classList.contains('timer-name')) return;
                if (!getPwd()) {
                    showGate('âŒ ì¸ì¦ í•„ìš”: ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                    return;
                }
                const row = input.closest('.timer-item');
                if (!row) return;
                const id = row.getAttribute('data-timer-id');
                if (!id) return;
                const nextName = input.value?.trim() ?? '';
                const current = timerIndex.get(id);
                if (current && nextName === current.name) {
                    input.value = current.name;
                    return;
                }

                input.readOnly = true;
                try {
                    await requestTimer(`/api/timers/${id}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        credentials: 'same-origin',
                        body: JSON.stringify({ name: nextName })
                    });
                } catch (e) {
                    const fallback = timerIndex.get(id);
                    input.value = fallback ? fallback.name : 'ìƒˆ íƒ€ì´ë¨¸';
                } finally {
                    input.readOnly = false;
                }
            });
        }

        const formatDepositValue = (detail = {}) => {
            if (!detail.hasReservation) return '<span class="cell-empty">-</span>';
            const value = detail.deposit ?? detail.rawDeposit;
            if (value == null || value === '') return '<span class="cell-empty">-</span>';
            const num = Number(value);
            if (Number.isNaN(num)) {
                return `<span class="deposit">${escapeHtml(value)}</span>`;
            }
            return `<span class="deposit">${num.toLocaleString('ko-KR')}</span>`;
        };
        // â”€â”€ "í˜„ì¬ ì˜ˆì•½ í˜„í™©" ì¹´ë“œ ìš”ì†Œ ì°¾ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function findReservationCard() {
            const byId = document.getElementById('reservationStatusCard');
            if (byId) return byId;
            const headings = Array.from(document.querySelectorAll('h1, h2, h3, h4'));
            const h = headings.find(el => el.textContent.trim().includes('í˜„ì¬ ì˜ˆì•½ í˜„í™©'));
            if (!h) return null;
            const candidates = [h.closest('.card'), h.closest('section'), h.closest('article'), h.parentElement].filter(Boolean);
            return candidates[0] || null;
        }

        // â”€â”€ ë¸Œë¼ìš°ì € í™”ë©´ ê³µìœ  ê¸°ë°˜ ìº¡ì³(ì„ íƒëœ í‘œë©´ì—ì„œ ëŒ€ìƒ ìš”ì†Œ ì˜ì—­ë§Œ í¬ë¡­) â”€â”€
        async function captureCardViaScreenShare(targetEl) {
            const stream = await navigator.mediaDevices.getDisplayMedia({
                video: { displaySurface: 'browser' },
                audio: false
            });
            try {
                const video = document.createElement('video');
                video.srcObject = stream;
                video.muted = true;
                video.playsInline = true;
                await video.play();
                await new Promise(r => { if (video.readyState >= 2) r(); else video.onloadeddata = () => r(); });

                const rect = targetEl.getBoundingClientRect();
                const cssW = window.innerWidth;
                const cssH = window.innerHeight;
                const vidW = video.videoWidth;
                const vidH = video.videoHeight;
                const scaleX = vidW / cssW;
                const scaleY = vidH / cssH;

                const sx = Math.round(rect.left * scaleX);
                const sy = Math.round(rect.top * scaleY);
                const sw = Math.max(1, Math.round(rect.width * scaleX));
                const sh = Math.max(1, Math.round(rect.height * scaleY));

                const canvas = document.createElement('canvas');
                canvas.width = sw;
                canvas.height = sh;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, sx, sy, sw, sh, 0, 0, sw, sh);

                return canvas.toDataURL('image/png');
            } finally {
                stream.getTracks().forEach(t => t.stop());
            }
        }

        // â”€â”€ í™”ë©´ ì „ì†¡ ë²„íŠ¼ ì„¤ì • â”€â”€
        (function setupScreenshotSender() {
            const btn = document.getElementById('sendScreenshot');
            if (!btn) return;
            btn.addEventListener('click', async () => {
                try {
                    if (!getPwd()) {
                        showGate('âŒ ì¸ì¦ í•„ìš”: ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                        return;
                    }
                    btn.disabled = true;
                    const prev = btn.textContent;
                    btn.textContent = 'ì „ì†¡ ì¤€ë¹„ì¤‘...';

                    const targetEl = findReservationCard();
                    if (!targetEl) throw new Error('ìº¡ì³ ëŒ€ìƒ(í˜„ì¬ ì˜ˆì•½ í˜„í™© ì¹´ë“œ)ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. id="reservationStatusCard"ë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”.');

                    const dataUrl = await captureCardViaScreenShare(targetEl);

                    btn.textContent = 'ì—…ë¡œë“œì¤‘...';
                    const r = await fetch('/api/screenshot', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeaders() },
                        body: JSON.stringify({ image: dataUrl })
                    });
                    const j = await r.json().catch(() => ({}));
                    if (!r.ok || !j?.ok) throw new Error(j?.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨');

                    btn.textContent = 'âœ… ì „ì†¡ ì™„ë£Œ';
                    setTimeout(() => { btn.textContent = prev; btn.disabled = false; }, 1200);
                } catch (e) {
                    alert('í™”ë©´ ì „ì†¡ ì‹¤íŒ¨: ' + (e?.message || e));
                    btn.disabled = false;
                    btn.textContent = 'ğŸ–¼ï¸ í™”ë©´ ì „ì†¡';
                }
            });
        })();


        // â”€â”€ í—¤ë” ëª¨ë‹¬ ì œì–´ â”€â”€
        function openDialogById(id) {
            if (!id) return;
            const dialog = $(id);
            if (!dialog) return;
            if (typeof dialog.showModal === 'function') {
                dialog.showModal();
            } else {
                dialog.setAttribute('open', '');
            }
        }

        function closeDialog(dialog) {
            if (!dialog) return;
            if (typeof dialog.close === 'function') {
                dialog.close();
            } else {
                dialog.removeAttribute('open');
            }
        }

        document.querySelectorAll('[data-open-modal]').forEach(btn => {
            const target = btn.getAttribute('data-open-modal');
            btn.addEventListener('click', () => {
                if (!getPwd()) {
                    showGate('âŒ ì¸ì¦ í•„ìš”: ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                    return;
                }
                openDialogById(target);
            });
        });

        document.querySelectorAll('[data-close-modal]').forEach(btn => {
            btn.addEventListener('click', () => closeDialog(btn.closest('dialog')));
        });


        document.querySelectorAll('[data-nav-target]').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.getAttribute('data-nav-target') || 'home';
                if (!getPwd()) {
                    showGate('âŒ ì¸ì¦ í•„ìš”: ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                    return;
                }
                activateView(target);
            });
        });


        async function jsonOrThrow(r) {
            if (!r.ok) {
                if (r.status === 401) { clearPwd(); showGate('âŒ ì¸ì¦ ì‹¤íŒ¨. ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”.'); }
                const t = await r.text().catch(() => '');
                throw new Error(`HTTP ${r.status} ${r.statusText} | ${t.slice(0, 200)}`);
            }
            return r.json();
        }

        function showApp(view = 'home') {
            gate.classList.add('hidden');
            app.classList.remove('hidden');
            activateView(view);
        }

        function showGate(msg = '') {
            app.classList.add('hidden');
            gate.classList.remove('hidden');
            gateMsg.textContent = msg;
            activeView = 'home';
            statusViewInitialized = false;
            timersLoadedOnce = false;
            timerData = [];
            timerIndex = new Map();
            stopTimerTicker();
            if (headerActions) {
                headerActions.classList.add('hidden');
            }
            Object.values(viewSections).forEach(el => el && el.classList.add('hidden'));
            if (timerList) {
                timerList.innerHTML = '<div class="timer-empty">íƒ€ì´ë¨¸ë¥¼ ì¶”ê°€í•˜ë©´ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.</div>';
            }
        }

        function showMsg(el, msg, type = '') {
            el.textContent = msg;
            el.classList.remove('hidden', 'success', 'error');
            if (type) el.classList.add(type);
        }

        const statusBox = $('statusBox');
        const mBox = $('mBox');

        function fmtTime(t) {
            if (!t) return '--:--';
            const h = String(t.hour ?? '').padStart(2, '0');
            const m = String(t.minute ?? '').padStart(2, '0');
            return `${h}:${m}`;
        }

        function gearBtn(id) {
            return `<button class="gear" data-gear="${id}" title="ì¶œë°œì‹œê°„ ìˆ˜ì •">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v6m0 6v6M1 12h6m6 0h6"/>
                    <path d="m4.93 4.93 4.24 4.24m5.66 5.66 4.24 4.24M4.93 19.07l4.24-4.24m5.66-5.66 4.24-4.24"/>
                </svg>
            </button>`;
        }

        // Legacy helper retained to prevent runtime errors in cached scripts expecting renderSlot.
        function renderSlot(label, value) {
            const slotLabel = escapeHtml(label ?? '');
            const rawValue = typeof value === 'string' ? value.trim() : '';
            const empty = !rawValue;
            const slotValue = escapeHtml(empty ? 'êµ¬ì¸ì¤‘' : rawValue);
            return `<div class="slot">` +
                `<span class="slot-label">${slotLabel}</span>` +
                `<span class="slot-value ${empty ? 'empty' : ''}">${slotValue}</span>` +
            `</div>`;
        }

        const slotOrder = [
            { key: 'first', heading: '1ìˆœ' },
            { key: 'second', heading: '2ìˆœ' },
            { key: 'third', heading: '3ìˆœ' },
            { key: 'skillbook1', heading: 'ìŠ¤í‚¬ë¶1' },
            { key: 'skillbook2', heading: 'ìŠ¤í‚¬ë¶2' }
        ];

        const rowOrder = [
            { key: 'nickname', label: 'ë‹‰ë„¤ì„' },
            { key: 'incentive', label: 'ì¸ì„¼' },
            { key: 'deposit', label: 'ì˜ˆì•½ê¸ˆ' },
            { key: 'loot', label: 'ë“ ì—¬ë¶€' },
            { key: 'exchange', label: 'êµí™˜' },
            { key: 'party', label: 'íŒŒí‹°' }
        ];

        function renderReservationCell(rowKey, column) {
            const detail = column.detail || {};
            const hasReservation = !!detail.hasReservation;
            const slotId = column.slotId;

            if (rowKey === 'nickname') {
                if (!hasReservation) {
                    const bookName = detail.skillbookName ? `<span class="cell-sub">${escapeHtml(detail.skillbookName)}</span>` : '';
                    return `<div class="cell-stack"><span class="cell-empty">êµ¬ì¸ì¤‘</span>${bookName}</div>`;
                }
                const name = `<span class="cell-value">${escapeHtml(detail.nickname)}</span>`;
                const bookName = detail.skillbookName ? `<span class="cell-sub">${escapeHtml(detail.skillbookName)}</span>` : '';
                return `<div class="cell-stack">${name}${bookName}</div>`;
            }

            if (rowKey === 'incentive') {
                if (!hasReservation || !detail.incentive) {
                    return '<span class="cell-empty">-</span>';
                }
                return `<span class="cell-value">${escapeHtml(detail.incentive)}</span>`;
            }

            if (rowKey === 'deposit') {
                return formatDepositValue(detail);
            }

            if (rowKey === 'loot') {
                const disabled = !hasReservation;
                const checked = !disabled && lootState[slotId];
                const classes = ['loot-mark'];
                if (disabled) classes.push('is-disabled');
                return `<label class="${classes.join(' ')}">
                    <input type="checkbox" ${disabled ? 'disabled' : ''} data-loot-slot="${escapeAttr(slotId)}" data-slot-active="${disabled ? '0' : '1'}" ${checked ? 'checked' : ''} />
                    <span>íšë“</span>
                </label>`;
            }

            if (rowKey === 'exchange' || rowKey === 'party') {
                if (!hasReservation) {
                    return '<span class="cell-empty">-</span>';
                }
                const prefix = rowKey === 'exchange' ? '/êµí™˜ ' : '/íŒŒí‹°ì´ˆëŒ€ ';
                const label = rowKey === 'exchange' ? 'êµí™˜' : 'íŒŒí‹°';
                const text = `${prefix}${detail.nickname}`;
                return `<button type="button" class="copy-btn" data-copy-text="${escapeAttr(text)}" data-copy-label="${label}" data-slot="${escapeAttr(slotId)}">${label}</button>`;
            }

            return '<span class="cell-empty">-</span>';
        }

        function renderTurnSection(label, gearKey, time, detail = {}, extraClass = '', turnKey = '', skillbookDetail = {}) {
            const slots = slotOrder.map(col => {
                const slotId = col.key.startsWith('skillbook') ? col.key : `${turnKey}-${col.key}`;
                const baseDetail = col.key.startsWith('skillbook') ? skillbookDetail[col.key] : detail[col.key];
                return {
                    ...col,
                    slotId,
                    detail: baseDetail || {}
                };
            });

            const headerRow = rowOrder.map(row => `<th scope="col">${row.label}</th>`).join('');
            const bodyRows = slots.map(slot => {
                const cells = rowOrder.map(row => `<td>${renderReservationCell(row.key, slot)}</td>`).join('');
                return `<tr><th scope="row">${slot.heading}</th>${cells}</tr>`;
            }).join('');

            return `<section class="turn-section ${extraClass}">
                <div class="turn-header">
                    <div class="turn-title">
                        <span>${label}</span>
                        <span class="turn-time">${fmtTime(time)}</span>
                    </div>
                    ${gearBtn(gearKey)}
                </div>
                <div class="table-wrapper">
                    <table class="reservation-table">
                        <thead>
                            <tr>
                                <th scope="col">êµ¬ë¶„</th>
                                ${headerRow}
                            </tr>
                        </thead>
                        <tbody>
                            ${bodyRows}
                        </tbody>
                    </table>
                </div>
            </section>`;
        }

        async function copyTextToClipboard(text) {
            if (!text) return false;
            try {
                if (navigator.clipboard?.writeText) {
                    await navigator.clipboard.writeText(text);
                } else {
                    const temp = document.createElement('textarea');
                    temp.value = text;
                    temp.style.position = 'fixed';
                    temp.style.opacity = '0';
                    document.body.appendChild(temp);
                    temp.focus();
                    temp.select();
                    document.execCommand('copy');
                    temp.remove();
                }
                return true;
            } catch (err) {
                console.error('clipboard error', err);
                return false;
            }
        }

        function attachCopyHandlers(root) {
            root.querySelectorAll('button.copy-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    if (btn.disabled) return;
                    const text = btn.getAttribute('data-copy-text');
                    const label = btn.getAttribute('data-copy-label') || btn.textContent;
                    const ok = await copyTextToClipboard(text);
                    if (!ok) return;
                    btn.textContent = 'ë³µì‚¬ë¨!';
                    btn.classList.add('copied');
                    setTimeout(() => {
                        btn.textContent = label;
                        btn.classList.remove('copied');
                    }, 1200);
                });
            });
        }

        function applyLootState(root) {
            const activeSlots = new Set();
            root.querySelectorAll('[data-loot-slot]').forEach(input => {
                const slot = input.getAttribute('data-loot-slot');
                if (!slot) return;
                const isActive = input.getAttribute('data-slot-active') === '1' && !input.disabled;
                if (!isActive) {
                    input.checked = false;
                    if (lootState[slot]) delete lootState[slot];
                    return;
                }
                activeSlots.add(slot);
                input.checked = !!lootState[slot];
            });
            Object.keys(lootState).forEach(key => {
                if (!activeSlots.has(key)) {
                    delete lootState[key];
                }
            });
            saveLootState();
        }

        function bindLootCheckboxes(root) {
            root.querySelectorAll('[data-loot-slot]').forEach(input => {
                input.addEventListener('change', () => {
                    const slot = input.getAttribute('data-loot-slot');
                    if (!slot) return;
                    if (input.checked) {
                        lootState[slot] = true;
                    } else {
                        delete lootState[slot];
                    }
                    saveLootState();
                    root.querySelectorAll(`[data-loot-slot="${slot}"]`).forEach(other => {
                        if (other === input) return;
                        if (other.disabled) return;
                        other.checked = input.checked;
                    });
                });
            });
        }

        function renderExtraCard(title, data, extraClass = '') {
            const isObject = data && typeof data === 'object';
            const reservation = isObject ? data?.reservation : data;
            const subtitle = isObject ? data?.name : '';
            const str = reservation == null ? '' : String(reservation).trim();
            const isEmpty = !str;
            const display = isEmpty ? 'êµ¬ì¸ì¤‘' : str;
            const name = subtitle ? `<div class="cell-sub">${escapeHtml(subtitle)}</div>` : '';
            return `<div class="extra-card ${extraClass}">
                <div class="extra-title">${title}</div>
                <div class="extra-content ${isEmpty ? 'empty' : ''}">${display}</div>
                ${name}
            </div>`;
        }

        function renderStatus(j) {
            const t1 = j?.departureTimes?.turn1;
            const t2 = j?.departureTimes?.turn2;
            const turnRowHtml = `
                <div class="turn-row">
                    ${renderTurnSection('ğŸ”¸ 1íŠ¸', 't1', t1, j?.turn1Details, '', 't1', j?.skillbookDetails)}
                    ${renderTurnSection('ğŸ”¹ 2íŠ¸', 't2', t2, j?.turn2Details, 'turn2', 't2', j?.skillbookDetails)}
                </div>`;

            const sb1 = j?.skillbook1 ?? {};
            const sb2 = j?.skillbook2 ?? {};
            const enre = Array.isArray(j?.enreEat) ? j.enreEat : [];

            const extraHtml = `
                <div class="extra-grid">
                    ${renderExtraCard('ğŸ“š ìŠ¤í‚¬ë¶1', sb1)}
                    ${renderExtraCard('ğŸ“š ìŠ¤í‚¬ë¶2', sb2, 'skill2')}
                    ${renderExtraCard('ğŸ‘¼ ì—”ë ˆë¨¹ì', enre.length ? enre.join(', ') : '', 'enre')}
                </div>`;

            statusBox.innerHTML = turnRowHtml + extraHtml;
            attachCopyHandlers(statusBox);
            applyLootState(statusBox);
            bindLootCheckboxes(statusBox);

            $('p1').value = j?.prices?.firstSecond ?? '';
            $('p2').value = j?.prices?.third ?? '';
            $('p3').value = j?.prices?.skillbook1 ?? '';
            $('p4').value = j?.prices?.skillbook2 ?? '';

            statusBox.querySelectorAll('[data-gear]').forEach(btn => {
                btn.onclick = () => openTimeModal(btn.getAttribute('data-gear'), j);
            });

            const members = Array.isArray(j?.guildMembers) ? j.guildMembers : [];
            if (!members.length) {
                mBox.innerHTML = '<div class="status-msg">ë“±ë¡ëœ ê³µëŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤</div>';
            } else {
                mBox.innerHTML = members.map(m => `
                    <div class="member-item">
                        <div class="member-info">
                            <span class="member-name">${m.nickname}</span>
                            <span class="member-job">${m.job}</span>
                        </div>
                    </div>`).join('');
            }
        }

        async function loadStatus() {
            statusViewInitialized = true;
            statusBox.innerHTML = '<div class="status-msg">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            try {
                const r = await fetch('/api/status', { headers: authHeaders(), credentials: 'same-origin' });
                const j = await jsonOrThrow(r);
                renderStatus(j);
            } catch (e) {
                statusBox.innerHTML = `<div class="status-msg error">ì—ëŸ¬: ${e.message}</div>`;
            }
        }

        $('savePrices').onclick = async () => {
            const msg = $('priceMsg');
            showMsg(msg, 'ì €ì¥ ì¤‘...');
            try {
                const body = {
                    firstSecond: $('p1').value,
                    third: $('p2').value,
                    skillbook1: $('p3').value,
                    skillbook2: $('p4').value
                };
                const r = await fetch('/api/prices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(body),
                    credentials: 'same-origin'
                });
                await jsonOrThrow(r);
                showMsg(msg, 'âœ… ì‹œì„¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } catch (e) {
                showMsg(msg, 'âŒ ' + e.message, 'error');
            }
        };

        $('resetSome').onclick = async () => {
            const msg = $('resetMsg');
            showMsg(msg, 'ì§„í–‰ ì¤‘...');
            try {
                const items = Array.from($('resetSel').selectedOptions).map(o => o.value);
                const r = await fetch('/api/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ items }),
                    credentials: 'same-origin'
                });
                const j = await jsonOrThrow(r);
                showMsg(msg, 'âœ… ì´ˆê¸°í™”ë¨: ' + (j.resetItems?.join(', ') || '-'), 'success');
            } catch (e) {
                showMsg(msg, 'âŒ ' + e.message, 'error');
            }
        };

        $('resetAll').onclick = async () => {
            if (!confirm('ì •ë§ ëª¨ë“  ì˜ˆì•½ì„ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
            const msg = $('resetMsg');
            showMsg(msg, 'ì§„í–‰ ì¤‘...');
            try {
                const r = await fetch('/api/reset-all', {
                    method: 'POST',
                    headers: authHeaders(),
                    credentials: 'same-origin'
                });
                await jsonOrThrow(r);
                showMsg(msg, 'âœ… ëª¨ë“  ì˜ˆì•½ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } catch (e) {
                showMsg(msg, 'âŒ ' + e.message, 'error');
            }
        };

        $('mAdd').onclick = async () => {
            const nickname = prompt('ê³µëŒ€ì› ë‹‰ë„¤ì„:');
            if (!nickname) return;
            const job = prompt('ì§ì—…:');
            if (!job) return;
            const msg = $('mMsg');
            showMsg(msg, 'ì¶”ê°€ ì¤‘...');
            try {
                const r = await fetch('/api/members', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ nickname, job }),
                    credentials: 'same-origin'
                });
                await jsonOrThrow(r);
                showMsg(msg, 'âœ… ê³µëŒ€ì›ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                loadStatus();
            } catch (e) {
                showMsg(msg, 'âŒ ' + e.message, 'error');
            }
        };

        $('mDel').onclick = async () => {
            const nickname = prompt('ì‚­ì œí•  ë‹‰ë„¤ì„:');
            if (!nickname) return;
            const msg = $('mMsg');
            showMsg(msg, 'ì‚­ì œ ì¤‘...');
            try {
                const r = await fetch('/api/members', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify({ nickname }),
                    credentials: 'same-origin'
                });
                await jsonOrThrow(r);
                showMsg(msg, 'âœ… ê³µëŒ€ì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                loadStatus();
            } catch (e) {
                showMsg(msg, 'âŒ ' + e.message, 'error');
            }
        };

        $('mReload').onclick = loadStatus;

        const timeDialog = $('timeDialog');
        const th = $('th');
        const tm = $('tm');
        const timeTitle = $('timeTitle');
        let editingTurn = null;

        function openTimeModal(turnKey, snapshot) {
            editingTurn = turnKey;
            const target = (turnKey === 't1') ? snapshot?.departureTimes?.turn1 : snapshot?.departureTimes?.turn2;
            timeTitle.textContent = (turnKey === 't1') ? 'â° ì¶œë°œì‹œê°„ ë³€ê²½ - 1íŠ¸' : 'â° ì¶œë°œì‹œê°„ ë³€ê²½ - 2íŠ¸';
            th.value = target?.hour ?? '';
            tm.value = target?.minute ?? '';
            if (typeof timeDialog.showModal === 'function') {
                timeDialog.showModal();
            } else {
                const h = prompt(timeTitle.textContent + ' | ì‹œ(0-23):', th.value ?? '');
                if (h == null) return;
                const m = prompt(timeTitle.textContent + ' | ë¶„(0-59):', tm.value ?? '');
                if (m == null) return;
                th.value = h;
                tm.value = m;
                saveTime();
            }
        }

        $('timeCancel').onclick = () => timeDialog.close();
        $('timeSave').onclick = saveTime;

        async function saveTime() {
            if (!editingTurn) return;
            const h = parseInt(th.value, 10);
            const m = parseInt(tm.value, 10);
            const body = (editingTurn === 't1')
                ? { turn1Hour: h, turn1Minute: m }
                : { turn2Hour: h, turn2Minute: m };
            try {
                const r = await fetch('/api/times', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeaders() },
                    body: JSON.stringify(body),
                    credentials: 'same-origin'
                });
                await jsonOrThrow(r);
                timeDialog.close();
                loadStatus();
            } catch (e) {
                alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
            } finally {
                editingTurn = null;
            }
        }

        $('loginBtn').onclick = async () => {
            const v = $('pwd').value?.trim();
            if (!v) {
                gateMsg.textContent = 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
                return;
            }
            setPwd(v);
            gateMsg.textContent = 'í™•ì¸ ì¤‘...';
            try {
                const r = await fetch('/api/status', {
                    headers: authHeaders(),
                    credentials: 'same-origin'
                });
                await jsonOrThrow(r);
                statusViewInitialized = true;
                showApp('home');
                loadStatus();
                connectSocket();
            } catch {
                gateMsg.textContent = 'âŒ ì ‘ì† ì‹¤íŒ¨';
                clearPwd();
            }
        };

        $('pwd').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') $('loginBtn').click();
        });

        let socket;
        function connectSocket() {
            if (socket) {
                try { socket.disconnect(); } catch { }
            }
            socket = io('/', {
                path: '/socket.io',
                auth: { pwd: getPwd() }
            });
            socket.on('status', (data) => {
                const j = data?.status;
                if (j) renderStatus(j);
            });
            socket.on('timers', (data) => {
                const snapshot = data?.snapshot || data;
                if (snapshot) setTimerSnapshot(snapshot);
            });
            socket.on('connect_error', (err) => {
                if (String(err?.message || '').includes('unauthorized')) {
                    clearPwd();
                    showGate('âŒ ì¸ì¦ ì‹¤íŒ¨. ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”.');
                }
                setTimeout(connectSocket, 1500);
            });
            socket.on('disconnect', () => setTimeout(connectSocket, 1500));
        }

        if (getPwd()) {
            statusViewInitialized = true;
            showApp('home');
            loadStatus();
            connectSocket();
        } else {
            showGate();
        }
    </script>
</body>

</html>